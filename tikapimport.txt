import mysql.connector
from mysql.connector import Error
from tika import parser
from multiprocessing import Pool

#SET the RECORD ID Here:
recid = 5

#SET FILE to UPLOAD HERE:http://localhost:8889/notebooks/backupTikaTestPy2MySQL.ipynb#

#file ='c:/signwithwords.jpg'
#file = 'c:/cats.html'
#file = 'c:/c.pdf'
#file = 'c:/DST_Test.pptx'
#file = 'c:/policiesandprocedures.pdf'
#file = 'c:/TestPDF.pdf'
file = 'c:/BEL_MWR_Map_2017_-_lo.pdf'
# Parse data from file
file_data = parser.from_file(file)



### TO DO parse out author and createdate
### Use Spark bulk reading to pull into this project. 

# Get files text content
text = file_data['content']
text = text
print(text)
print(file)

try:
    def tika_parser(file_path):
    # Extract text from document
      content = parser.from_file(file_path)    
      #text = content['content']
   
    # Convert to string
    text = str(text)
    # Ensure text is utf-8 formatted
    safe_text = text.encode('utf-8', errors='ignore')
    # Escape any \ issues
    safe_text = str(safe_text).replace('\\', ' ').replace('"', ' ')
    safe_text = str(safe_text).replace('n n', ' ').replace('n', 'n')
    safe_text = str(safe_text).replace('b  ', ' ').replace('n', 'n')
    
    
    print("-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*")
    print("Key and Values: ")
    print("  ")
    for key, value in file_data.items():
     (key, value)
    key, val = next(iter(file_data.items())) 
    
    #Hold onto this guy to be able to query your blob text
    #SELECT CONVERT(myvalue USING utf8) FROM tika.testtable;
    
    print("~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~")
    mykey = key
    print(mykey)
    myval = str(val)[0:250]
    print(myval)    
    #print(safe_val.split( ))
    
    
    connection = mysql.connector.connect(host='Laptop-P4FVLFPQ',
                                         database='tika',
                                         user='DST2',
                                         password= '1234!@#$qwerQWER')
    
    #Set the buffered equal to true to keep on trucking. 
    cursor = connection.cursor(buffered=True)

    #print("Before updating a record ")
    sql_select_query = """select * from tika.testtable"""
    
    cursor.execute(sql_select_query)
    record = cursor.fetchone()
    print(record)

    # Update single record now
    update_query = f'UPDATE tika.testtable SET testdatafilepath = "{file}" WHERE testid ="{recid}";'
    
    cursor.execute(update_query)
    connection.commit()
    print("FilePath Updated successfully ")

    update_query = f'UPDATE tika.testtable SET testdata = "{safe_text}" WHERE testid ="{recid}";'
    
    cursor.execute(update_query)
    connection.commit()
    print("TestData Updated successfully ")
    
    update_query = f'UPDATE tika.testtable SET mykey = "{mykey}" WHERE testid ="{recid}";'
    
    cursor.execute(update_query)
    connection.commit()
    print("TestData KEY Updated successfully ")
    
    update_query = f'UPDATE tika.testtable SET myvalue = "{myval}" WHERE testid ="{recid}";'
    
    cursor.execute(update_query)
    connection.commit()
    print("TestData MyValue Updated successfully ")

    print("After updating record ")
    cursor.execute(update_query)
    record = cursor.fetchone()
    print(record)

except mysql.connector.Error as error:
    print("Failed to update table record: {}".format(error))
finally:
    if (connection.is_connected()):
        connection.close()
        print("MySQL connection is closed")
